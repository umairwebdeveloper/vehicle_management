{% extends "base.html" %} {% block content %}
<div class="container my-5">
    <h1 class="mb-4">Forum</h1>

    <form method="get" class="row g-3 mb-4">
        <div class="col-md-5">
            <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="Search‚Ä¶" />
        </div>
        <div class="col-md-4">
            <select name="category" class="form-select">
                <option value="">All Categories</option>
            </select>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">üîç Search</button>
        </div>
    </form>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{% url 'forum:post_create' %}" class="btn btn-success">Ask a Question</a>
        <span class="text-muted">Total Posts: {{ posts.paginator.count }}</span>
    </div>

    {% for post in posts %}
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">
                <a href="{{ post.get_absolute_url }}" class="text-decoration-none"> {{ post.title }} </a>
                {% if post.solved %}
                <span class="badge bg-success ms-2">Solved</span>
                {% endif %}
            </h5>
            <p class="card-text text-truncate">{{ post.body|truncatechars:150 }}</p>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted"> By {{ post.author.username }} in {{ post.category.name }} ‚Ä¢ {{ post.created|date:"M d, Y" }} </small>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-outline-secondary btn-sm reply-btn me-2" data-post-id="{{ post.pk }}" data-post-title="{{ post.title|escapejs }}">üí¨ {{ post.reply_count }}</button>
                    <a href="{% url 'forum:upvote' post.pk %}" class="btn btn-outline-primary btn-sm"> üëç {{ post.upvote_count }} </a>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <p>No posts found.</p>
    {% endfor %}
</div>
<div class="modal fade" id="replyModal" tabindex="-1" aria-labelledby="replyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="replyModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="replyModalBody">
                <!-- Loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}{% block scripts %}
<script>

    $(function () {
        $(".reply-btn").on("click", function () {
            const postId = $(this).data("post-id")
            $("#replyModalLabel").text($(this).data("post-title"))
            $("#replyModalBody").html('<p class="text-center py-3">Loading‚Ä¶</p>')
            $.get(`/forum/post/${postId}/replies/`, (data) => {
                $("#replyModalBody").html(data)
            })
            new bootstrap.Modal($("#replyModal")).show()
        })

        $(document).on("click", ".reply-to-reply-btn", function () {
            const parentId = $(this).data("parent-id")
            $("#id_parent").val(parentId)
            $("html, body").animate(
                {
                    scrollTop: $("#modalReplyForm").offset().top - 100,
                },
                300
            )
        })

        $(document).on("submit", "#modalReplyForm", function (e) {
            e.preventDefault()
            const $form = $(this)
            $.post($form.attr("action"), $form.serialize(), (data) => {
                $("#replyModalBody").html(data)
            })
        })
    })
</script>
{% endblock %}
