{% extends "base.html" %} {% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'forum:post_list' %}">Public Posts</a></li>
        <li class="breadcrumb-item active" aria-current="page">My Posts</li>
    </ol>
</nav>
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>My Posts</h3>
    <div>
        <a href="{% url 'forum:post_list' %}" class="btn btn-info me-2"> Public Posts </a>
        <a href="{% url 'forum:post_create' %}" class="btn btn-primary"> <i class="bi bi-plus-circle"></i> Create Post </a>
    </div>
</div>
<div class="mb-5">
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-5">
            <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="Search‚Ä¶" />
        </div>
        <div class="col-md-4">
            <select name="category" class="form-select">
                <option value="">All Categories</option>
                {% for value, label in categories %}
                    <option value="{{ value }}"{% if value == current_category %} selected{% endif %}>
                    {{ label }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-success w-100">üîç Filter</button>
        </div>
    </form>

    {% for post in posts %}
    <div class="card mb-3">
        <div class="card-body">
        <div class="d-flex align-items-center gap-2 mb-2">
            <h5 class="card-title mb-0">
            <a href="{{ post.get_absolute_url }}" class="text-decoration-none">
                {{ post.title }}
            </a>
            </h5>
            {% if post.solved %}
            <span class="badge bg-success">Solved</span>
            {% endif %}
        </div>

        <p class="card-text text-truncate">
            {{ post.body|truncatechars:150 }}
        </p>

        {# ‚Äî Vehicle details box ‚Äî #}
        {% if post.share_vehicle and post.vehicle %}
            <div class="border rounded p-3 mb-3 bg-light">
            <h6 class="mb-2">Vehicle Details</h6>
            <ul class="list-unstyled mb-0">
                <li><strong>Reg No:</strong> {{ post.vehicle.reg_number }}</li>
                <li><strong>Make:</strong> {{ post.vehicle.make }}</li>
                <li><strong>Model:</strong> {{ post.vehicle.model }}</li>
                <li><strong>Year:</strong> {{ post.vehicle.year }}</li>
                {% if post.vehicle.vin %}
                <li><strong>VIN:</strong> {{ post.vehicle.vin }}</li>
                {% endif %}
            </ul>
            </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
            By {{ post.author.username }} ‚Ä¢ {{ post.created|date:"M d, Y" }}
            </small>

            <div class="d-flex align-items-center">
            <button
                type="button"
                class="btn btn-outline-secondary btn-sm reply-btn me-2"
                data-post-id="{{ post.pk }}"
                data-post-title="{{ post.title|escapejs }}"
            >
                üí¨ {{ post.reply_count }}
            </button>

            <a
                href="{% url 'forum:upvote' post.pk %}"
                class="btn btn-sm me-2
                {% if post.is_liked %}
                    btn-primary
                {% else %}
                    btn-outline-primary
                {% endif %}"
            >
                üëç {{ post.upvote_count }}
            </a>

            {# ‚Äî Edit button for author ‚Äî #}
            {% if post.author == request.user %}
                <a
                href="{% url 'forum:post-edit' post.pk %}"
                class="btn btn-outline-warning btn-sm"
                >
                <i class="bi bi-pencil-square"></i> Edit
                </a>
            {% endif %}
            </div>
        </div>
        </div>
    </div>
    {% empty %}
    <p>No posts found.</p>
    {% endfor %}

    {% include "partials/_pagination.html" %}
</div>
<div class="modal fade" id="replyModal" tabindex="-1" aria-labelledby="replyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="replyModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="replyModalBody">
                <!-- Loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}{% block scripts %}
<script>
$(function(){
  $('.reply-btn').on('click', function(){
    const postId = $(this).data('post-id');
    $('#replyModalLabel').text('Replies for Post #' + postId);
    $.get(
      "{% url 'forum:post-replies' 0 %}".replace('/0/','/'+postId+'/'),
      function(data){
        $('#replyModalBody').html(data.html);
        $('#replyModal').modal('show');
        bindReplyForm(postId);
      }
    );
  });

  function bindReplyForm(postId) {
    $('#id_reply_pk, #id_parent').val('');
    $('#reply-error-body').text('');

    $('.reply-to-btn').off('click').on('click', function(){
        const replyId   = $(this).data('reply-id');
        const replyBody = $(this).data('reply-body');
        $('#id_parent').val(replyId);
        $('#quote-text').text('> ' + replyBody);
        $('#quote-clear').show();
        $('#replybody').show();
        $('#id_body').focus();
    });

    $('#replybody').off('click', '#quote-clear').on('click', '#quote-clear', function(){
        $('#replybody').hide();
        $('#id_parent').val('');
        $('#quote-text').text('');
        $('#quote-clear').hide();
    });

    $('.reply-edit-btn').off('click').on('click', function(){
        const rid  = $(this).data('reply-id');
        const body = $(this).data('reply-body');
        $('#id_reply_pk').val(rid);
        $('#id_body').val(body).focus();
    });

    $('.reply-delete-btn').off('click').on('click', function(){
        if(!confirm('Delete this reply?')) return;
        const rid = $(this).data('reply-id');
        $.ajax({
        url: "{% url 'forum:reply-delete' 0 %}".replace('/0/', '/'+rid+'/'),
        method: 'POST',
        data: { csrfmiddlewaretoken: $('[name="csrfmiddlewaretoken"]').val() },
        success() {
            $('.reply-btn[data-post-id="'+postId+'"]').trigger('click');
            showToast('Reply deleted', 'success');
        }
        });
    });


    $('#replyForm').off('submit').on('submit', function(e){
      e.preventDefault();
      $.ajax({
        url: "{% url 'forum:reply-create' %}",
        method: 'POST',
        data: $(this).serialize(),
        success: function(){
          // 1) bump the visible count on the original reply-btn
          const btn = $('.reply-btn[data-post-id="'+postId+'"]');
          const current = parseInt(btn.text().replace(/\D/g,'')) || 0;
          btn.html('üí¨ ' + (current + 1));
          
          // 2) reload the modal contents
          $('.reply-btn[data-post-id="'+postId+'"]').trigger('click');

          showToast('Reply sent successfully!', 'success');
        },
        error: function(xhr){
          const errs = xhr.responseJSON.errors;
          if (errs.body) {
            $('#reply-error-body').text(errs.body.join(' '));
          }
          showToast('Error sending reply: ' + errs.body.join(' '), 'error');
        }
      });
    });
  }
});
</script>


{% endblock %}
